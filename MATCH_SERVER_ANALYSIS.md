# Match Server 설계 분석 및 개선 계획

## 📊 분석 개요

Match Server의 코드베이스를 체계적으로 분석하여 논리적 및 설계상 결함을 식별하고 개선 방안을 제시합니다.

## 🔴 심각한 설계 결함 (Critical Issues)

### 1. Redis 분산 락 경합 조건 (Race Condition)

**위치**: `match_server/src/matchmaker/lock.rs:32-59`

**문제점**:
- 분산 락 구현에서 `SET key value NX PX ms` 명령과 락 해제 스크립트 간 원자성 보장 부족
- 락 해제 시 Lua 스크립트를 사용하지만, 획득 시에는 단순 SET 명령 사용
- 네트워크 지연이나 Redis 클러스터 환경에서 경합 조건 발생 가능

**영향**:
- 동시 매치메이킹 시도 시 중복 매치 생성 가능
- 데이터 일관성 문제
- 플레이어가 여러 매치에 동시 배정될 위험

**해결 방안**:
1. 락 획득도 Lua 스크립트로 원자적 처리
2. 락 만료 시간과 heartbeat 메커니즘 추가
3. 락 소유자 검증 강화

### 2. 로딩 세션 타임아웃 처리 불일치

**위치**: `match_server/scripts/CLEANUP_STALE_SESSION_SCRIPT.lua:42-45`

**문제점**:
- Lua 스크립트에서 `status_val == 'ready'` 체크 후 빈 결과 반환
- Rust 코드에서는 이 경우를 명시적으로 처리하지 않음
- 로딩 완료된 세션이 정리되지 않아 메모리 누수 발생 가능

**영향**:
- Redis 메모리 누적 사용량 증가
- 불필요한 세션 데이터 축적
- 시스템 성능 저하

**해결 방안**:
1. 스크립트 결과 처리 로직 개선
2. 완료된 세션에 대한 명시적 정리 절차 추가
3. 세션 상태별 TTL 차등 적용

### 3. 블랙리스트 IP 변경 감지 로직의 보안 취약점

**위치**: `match_server/src/blacklist/mod.rs:71-90`

**문제점**:
- IP 변경만으로 모든 위반 기록이 삭제됨
- VPN/프록시 사용으로 제재 우회 가능
- 악의적 사용자의 시스템 남용 가능성

**영향**:
- 제재 시스템 무력화
- 게임 환경 품질 저하
- 정당한 사용자의 게임 경험 악화

**해결 방안**:
1. IP 변경 시 부분적 위반 기록 유지
2. 디바이스 핑거프린팅 추가 도입
3. 단계적 제재 완화 정책 구현

## 🟠 중간 수준 설계 결함 (Major Issues)

### 4. 메트릭 중복 계산

**위치**: `match_server/src/ws_session.rs:474-487`

**문제점**:
- `PLAYERS_REQUEUED_TOTAL` 메트릭이 여러 위치에서 부정확하게 증가
- 실제 재큐잉과 관계없는 상황에서도 카운터 증가
- 모니터링 데이터의 신뢰성 저하

**영향**:
- 부정확한 시스템 메트릭
- 운영 의사결정에 악영향
- 성능 분석 어려움

**해결 방안**:
1. 메트릭 계산 로직 중앙집중화
2. 메트릭 증가 조건 명확화
3. 메트릭 검증 테스트 추가

### 5. WebSocket 세션 상태 전환 불일치

**위치**: `match_server/src/ws_session.rs:114-151`

**문제점**:
- 중복 `StartLoading` 메시지 처리 시 상태 전환 로직 불완전
- 특정 상황에서 클라이언트와 서버 상태 불일치 발생
- 에러 상태 복구 메커니즘 부족

**영향**:
- 클라이언트-서버 동기화 문제
- 매치메이킹 실패율 증가
- 사용자 경험 저하

**해결 방안**:
1. 상태 전환 규칙 명확화
2. 상태 불일치 감지 및 복구 로직 추가
3. 클라이언트 상태 동기화 메커니즘 강화

### 6. Redis 연결 실패 시 무한 재시도

**위치**: `match_server/src/pubsub.rs:169-180`

**문제점**:
- 최대 재시도 횟수 도달 시 시스템 종료
- 대기 중인 플레이어에 대한 정리 절차 누락
- 그레이스풀 셧다운 실패

**영향**:
- 급작스러운 서비스 중단
- 플레이어 데이터 손실 가능성
- 운영 안정성 저하

**해결 방안**:
1. 셧다운 전 플레이어 상태 정리
2. 대체 Redis 인스턴스 자동 전환
3. 서킷 브레이커 패턴 도입

## 🟡 경미한 설계 결함 (Minor Issues)

### 7. 에러 처리 일관성 부족

**위치**: `match_server/src/errors.rs:102-125`

**문제점**:
- `MatchmakerError`를 `ServerMessage`로 변환 시 세부 에러 정보 손실
- 클라이언트에게 전달되는 에러 메시지 일관성 부족
- 디버깅 정보 부족

**영향**:
- 디버깅 어려움
- 사용자 경험 저하
- 문제 추적 복잡성 증가

**해결 방안**:
1. 구조화된 에러 응답 체계 구축
2. 에러 로깅 표준화
3. 클라이언트용/개발자용 에러 메시지 분리

### 8. 하드코딩된 설정 값들

**위치**: `match_server/src/matchmaker/handlers.rs:26`

**문제점**:
- `LOCK_DURATION_MS` 등 중요한 값들이 하드코딩
- 환경별 최적화 어려움
- 설정 변경 시 코드 수정 필요

**영향**:
- 운영 유연성 저하
- 환경별 튜닝 어려움
- 배포 복잡성 증가

**해결 방안**:
1. 설정 파일로 외부화
2. 환경 변수 지원 추가
3. 런타임 설정 변경 지원

### 9. AtomicBool 메모리 순서 명시 부족

**위치**: `match_server/src/state_events.rs:12-16`

**문제점**:
- `Relaxed` 메모리 순서 사용 시 즉시 반영 보장 없음
- 멀티스레드 환경에서 일관성 문제 가능
- 상태 이벤트 활성화/비활성화 지연 발생 가능

**영향**:
- 설정 변경 지연
- 예측 불가능한 동작
- 디버깅 복잡성

**해결 방안**:
1. 적절한 메모리 순서 명시
2. 설정 변경 확인 메커니즘 추가
3. 상태 변경 로깅 강화

## 📋 개선 우선순위 및 실행 계획

### Phase 1: Critical Issues (우선순위 1)
1. **Redis 분산 락 개선** - 2-3일
2. **로딩 세션 정리 로직 수정** - 1-2일  
3. **블랙리스트 보안 강화** - 3-4일

### Phase 2: Major Issues (우선순위 2)
4. **메트릭 시스템 정리** - 2일
5. **WebSocket 상태 관리 개선** - 2-3일
6. **Redis 장애 처리 강화** - 2-3일

### Phase 3: Minor Issues (우선순위 3)
7. **에러 처리 표준화** - 1-2일
8. **설정 외부화** - 1일
9. **동시성 안전성 강화** - 1일

## 🎯 기대 효과

- **시스템 안정성 향상**: 경합 조건 및 메모리 누수 해결
- **보안 강화**: 블랙리스트 우회 방지
- **운영 효율성 증대**: 정확한 메트릭 및 설정 외부화
- **개발 생산성 향상**: 일관된 에러 처리 및 디버깅 개선
- **사용자 경험 개선**: 안정적인 매치메이킹 서비스 제공

## 📝 다음 단계

1. **Phase 1 이슈들부터 순차적 해결**
2. **각 수정사항에 대한 테스트 케이스 작성**
3. **성능 벤치마크 수행**
4. **코드 리뷰 및 문서화**
5. **운영 환경 점진적 적용**