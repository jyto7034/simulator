# 버그 분석 및 해결 계획

이 문서는 `match_server`에서 발견된 잠재적 버그와 이를 해결하기 위한 계획을 기술합니다.

## 1. 유령 플레이어 문제 (Ghost Player in Queue)

### 문제 상황

1.  두 플레이어(A, B)가 매칭되어 로딩 세션에 들어갑니다.
2.  플레이어 A의 클라이언트가 강제 종료되거나 네트워크 연결이 끊깁니다.
3.  A의 `MatchmakingSession`은 `CancelLoadingSession` 메시지를 `Matchmaker`에게 보냅니다.
4.  `CancelLoadingSession` 핸들러는 로딩 세션에 있던 **모든** 플레이어(A와 B 모두)를 다시 대기열(queue)에 넣습니다.
5.  하지만 A의 세션은 이미 종료되었으므로, A는 ID만 대기열에 존재하는 **유령 플레이어**가 됩니다.
6.  이후 B와 새로운 플레이어 C가 대기열에 들어오면, `Matchmaker`는 B와 유령이 된 A를 매칭시킬 수 있습니다.
7.  새로운 매칭이 시작되어도 A는 응답할 수 없으므로, B는 로딩 타임아웃(60초)이 발생할 때까지 기다려야 하는 연쇄적인 매칭 실패가 발생합니다.

### 재현 방법 (`test_client` 수정)

1.  3개의 테스트 ��라이언트(A, B, C)를 동시에 실행하도록 `test_client`를 수정합니다.
2.  클라이언트 A와 B가 먼저 매칭을 요청하여 로딩 세션에 진입합니다.
3.  `StartLoading` 메시지를 받으면, 클라이언트 A는 즉시 연결을 끊습니다.
4.  클라이언트 B는 "매칭 취소" 알림을 받고 다시 대기열로 돌아갑니다. (여기까지는 정상)
5.  이후 클라이언트 C가 매칭을 요청합니다.
6.  **버그 발생**: `Matchmaker`가 B와 **유령이 된 A**를 다시 매칭시키려 시도하고, C는 계속 대기하게 됩니다. B와 C는 영원히 매칭되지 않습니다.
7.  **정상 동작**: `Matchmaker`가 B와 C를 성공적으로 매칭시켜야 합니다.

### 해결 방안 (`matchmaker/actor.rs` 수정)

-   `CancelLoadingSession` 핸들러 로직을 수정합니다.
    -   Redis에서 로딩 세션 정보를 가져온 후, 연결을 끊은 당사자(`msg.player_id`)를 제외한 **나머지 플레이어 목록**을 만듭니다.
    -   나머지 플레이어들에게만 "매칭 취소" 알림을 보내고, 그들만 다시 대기열에 넣습니다 (`requeue_players`).
-   `CheckStaleLoadingSessions` 핸들러도 유사하게 수정합니다. (타임아웃의 경우 모든 플레이어가 연관되어 있으므로, 모든 플레이어를 대기열로 돌려보내는 것이 맞을 수 있으나, 로직 일관성을 위해 확인이 필요합니다. 우선순위는 `CancelLoadingSession` 입니다.)

---

이 계획에 따라 먼저 `test_client`를 수정하여 버그를 재현하고, 이후 `match_server` 코드를 수정하여 문제를 해결하겠습니다.
