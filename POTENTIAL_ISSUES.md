# Match Server 잠재적 문제 및 개선 방안

이 문서는 현재 `match_server` 코드베이스를 분석하여 발견된 잠재적인 버그 및 개선점에 대해 기술한다.

---

## 1. (심각도: 높음) 존재하지 않는 게임 모드로 인한 플레이어 고립

-   **문제 상황:** 클라이언트가 서버 설정에 존재하지 않는 임의의 게임 모드(예: `"Arcade_2v2"`)로 매칭을 요청할 수 있다.
-   **현재 로직:** `EnqueuePlayer` 핸들러는 요청받은 `game_mode` 문자열을 검증하지 않고, 그대로 Redis에 `queue:{game_mode}` 키를 생성하여 플레이어를 추가한다.
-   **영향:** `Matchmaker`의 매칭 로직은 설정 파일에 정의된 게임 모드만 순회하므로, 존재하지 않는 대기열에 들어간 플레이어는 **연결을 끊기 전까지 영원히 매칭될 수 없다.** 이는 사용자 경험에 치명적이다.
-   **개선 방안:** `EnqueuePlayer` 핸들러에 수신된 `game_mode`가 `settings.game_modes` 목록에 존재하는 유효한 ID인지 확인하는 검증 단계를 추가한다. 유효하지 않을 경우, 에러 메시지를 클라이언트에게 전송하고 대기열 추가를 거부해야 한다.

## 2. (심각도: 높음) 서버 할당 실패 시 잘못된 대기열로 복귀하는 문제

-   **문제 상황:** 모든 플레이어가 로딩을 완료했지만, `dedicated_server`와의 통신 실패 등으로 게임 세션 생성이 실패할 경우, 플레이어들이 잘못된 대기열로 돌아간다.
-   **현재 로직:** `HandleLoadingComplete` 핸들러의 에러 처리 부분에서, 플레이어를 다시 대기열에 넣을 때 `let game_mode = "Normal_1v1".to_string();` 과 같이 게임 모드를 **하드코딩**하고 있다.
-   **영향:** "Ranked_1v1" 모드를 플레이하던 유저가 이 문제에 직면하면, "Normal_1v1" 대기열로 잘못 이동하게 된다. 이는 MMR 적용 누락, 다른 모드 유저와의 매칭 등 심각한 로직 오류를 유발한다.
-   **개선 방안:**
    1.  `ATOMIC_LOADING_COMPLETE_SCRIPT` Lua 스크립트가 플레이어 목록과 함께 `game_mode`도 반환하도록 수정한다.
    2.  `HandleLoadingComplete` 핸들러는 스크립트에서 반환된 `game_mode`를 사용하여, 실패 시 정확한 대기열로 플레이어를 복귀시켜야 한다.

## 3. (심각도: 중간) 프로덕션 환경에서 Redis 성능 저하 유발 가능성

-   **문제 상황:** `DedicatedServerProvider`와 `CheckStaleLoadingSessions` 핸들러가 Redis에서 특정 패턴�� 키를 찾기 위해 `KEYS` 명령어를 사용하고 있다.
-   **현재 로직:**
    -   `provider.rs`: `KEYS "dedicated_server:*"`
    -   `matchmaker/actor.rs`: `redis.keys::<_, Vec<String>>("loading:*")`
-   **영향:** Redis 공식 문서에 따르면 `KEYS` 명령어는 동기적으로 동작하여 전체 키 공간을 스캔하는 동안 다른 모든 요청을 차단(blocking)한다. 이는 키가 많은 프로덕션 환경에서 Redis 서버 전체의 성능을 심각하게 저하시키고, 시스템 장애의 원인이 될 수 있다.
-   **개선 방안:** `KEYS`를 `SCAN` 명령어로 전면 교체해야 한다. `SCAN`은 커서 기반의 점진적 스캔을 지원하여, Redis 서버를 차단하지 않고도 안전하게 키를 탐색할 수 있다.

## 4. (심각도: 낮음) Redis Pub/Sub 연결 리소스 유출 가능성

-   **문제 상황:** `ws_session.rs`에서 클라이언트가 접속할 때마다 `ctx.spawn`을 통해 Redis Pub/Sub 채널 구독을 위한 별도의 비동기 작업을 생성한다.
-   **현재 로직:** `actix` 액터가 중지될 때 `spawn`된 작업이 자동으로 취소되지만, 특정 예외 상황에서 이 취소가 100% 보장되지 않을 수 있다.
-   **영향:** 비정상적인 종료가 반복될 경우, 서버에 사용되지 않는 Redis 연결이 계속 누적되어 ��소스 유출(resource leak)로 이어질 수 있다.
-   **개선 방안:**
    -   **단기:** `ws_session` 액터가 `stopping` 메소드에서 `spawn`된 작업을 명시적으로 중단시키는 핸들(handle)을 관리하도록 로직을 보강한다.
    -   **장기:** `actix-redis`와 같이 액터의 생명주기와 Pub/Sub 스트림을 안전하게 통합 관리해주는 라이브러리 도입을 검토한다.
